<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Peringatan Dini Longsor Sukabumi</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  
  <style>
    /* Reset & Layout */
    body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    #map { height: 100vh; width: 100%; background: #ddd; }

    /* Judul Melayang */
    .map-title {
      position: absolute; 
      top: 20px; 
      left: 50%; 
      transform: translateX(-50%);
      z-index: 1000; 
      background: rgba(255, 255, 255, 0.9); 
      padding: 10px 25px; 
      border-radius: 30px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      text-align: center;
    }
    .map-title h2 { margin: 0; font-size: 18px; color: #2c3e50; }
    .map-title small { font-size: 12px; color: #7f8c8d; }

    /* Legenda di Pojok Kanan Bawah */
    .legend {
      background: white; 
      padding: 15px; 
      line-height: 24px; 
      color: #333;
      box-shadow: 0 0 15px rgba(0,0,0,0.2); 
      border-radius: 8px;
      font-size: 13px;
    }
    .legend h4 { margin: 0 0 10px; font-size: 14px; }
    .legend i {
      width: 18px; height: 18px; 
      float: left; 
      margin-right: 8px; 
      opacity: 0.9; 
      border-radius: 3px;
    }
    
    /* Loading Spinner di Popup */
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div class="map-title">
    <h2>SI Peringatan Dini Longsor</h2>
    <small>Data Curah Hujan Real-time (Open-Meteo)</small>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // --- 1. SETUP PETA DASAR ---
    // Koordinat Tengah Sukabumi
    var map = L.map('map').setView([-7.05, 106.9], 10); 

    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles ¬© Esri'
    });
    
    var street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    });

    var labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
        attribution: '¬© CartoDB'
    });

    // Default layer: Satelit + Label Nama Daerah
    satellite.addTo(map);
    labels.addTo(map);

    L.control.layers({ "Satelit": satellite, "Jalan": street }, { "Label Daerah": labels }).addTo(map);


    // --- 2. LOGIKA WARNA & STATUS ---
    function getRiskColor(rain) {
        if (rain > 50) return '#e74c3c'; // MERAH (Bahaya)
        if (rain > 20) return '#f1c40f'; // KUNING (Waspada)
        return '#2ecc71';                // HIJAU (Aman)
    }

    function getRiskStatus(rain) {
        if (rain > 50) return 'BAHAYA (Potensi Longsor)';
        if (rain > 20) return 'WASPADA (Tanah Basah)';
        return 'AMAN (Normal)';
    }


    // --- 3. MUAT DATA WILAYAH (GEOJSON) ---
    console.log("Memulai load data...");
    
    fetch('BatasSukabumi.json')
      .then(response => {
          if (!response.ok) throw new Error("Gagal load file JSON. Cek nama filenya!");
          return response.json();
      })
      .then(geojsonData => {
        
        console.log("JSON berhasil dimuat. Jumlah wilayah: " + geojsonData.features.length);

        L.geoJSON(geojsonData, {
          // RENDERER CANVAS (PENTING AGAR TIDAK LAG)
          renderer: L.canvas(),

          // Style Awal (Abu-abu sebelum data cuaca masuk)
          style: {
            color: 'white',
            weight: 1,
            fillOpacity: 0.6,
            fillColor: '#bdc3c7' 
          },

          onEachFeature: function(feature, layer) {
              // 1. Siapkan Nama & Titik Tengah
              var namaKec = feature.properties.NAME_3 || "Kecamatan";
              var namaKab = feature.properties.NAME_2 || "Sukabumi";
              var center = turf.centroid(feature).geometry.coordinates;

              // 2. Set Popup Loading Awal
              layer.bindPopup(`<div style="text-align:center"><b>${namaKec}</b><br><small>Memuat data lengkap...</small></div>`);

              // 3. Request API dengan PARAMETER TAMBAHAN
              // Kita minta: Hujan, Angin Maks, dan Probabilitas Hujan
              var url = `https://api.open-meteo.com/v1/forecast?latitude=${center[1]}&longitude=${center[0]}&daily=precipitation_sum,windspeed_10m_max,precipitation_probability_max&timezone=Asia%2FBangkok`;

              fetch(url)
                .then(res => res.json())
                .then(weatherData => {
                  // --- AMBIL DATA HARI INI (Index 0) ---
                  var hujanHariIni = weatherData.daily.precipitation_sum[0];
                  var anginHariIni = weatherData.daily.windspeed_10m_max[0];
                  var peluangHujan = weatherData.daily.precipitation_probability_max[0];

                  // --- AMBIL DATA BESOK (Index 1) ---
                  var hujanBesok = weatherData.daily.precipitation_sum[1];

                  // --- LOGIKA WARNA (Tetap pakai Hujan sebagai penentu utama) ---
                  layer.setStyle({
                      fillColor: getRiskColor(hujanHariIni),
                      fillOpacity: 0.7
                  });

                  // --- UPDATE POPUP MENJADI DASHBOARD INFORMASI ---
                  layer.setPopupContent(`
                      <div style="font-family:sans-serif; min-width:200px;">
                        <div style="background:${getRiskColor(hujanHariIni)}; color:white; padding:10px; border-radius:5px 5px 0 0; text-align:center;">
                          <h3 style="margin:0;">${namaKec}</h3>
                          <small>${getRiskStatus(hujanHariIni)}</small>
                        </div>

                        <div style="padding:10px; background:#f9f9f9; border:1px solid #ddd; border-top:none;">
                          <table style="width:100%; font-size:13px;">
                              <tr>
                                  <td style="color:#555;">üåßÔ∏è Curah Hujan:</td>
                                  <td style="font-weight:bold; text-align:right;">${hujanHariIni} mm</td>
                              </tr>
                              <tr>
                                  <td style="color:#555;">üí® Angin Kencang:</td>
                                  <td style="font-weight:bold; text-align:right;">${anginHariIni} km/h</td>
                              </tr>
                              <tr>
                                  <td style="color:#555;">üìä Peluang Hujan:</td>
                                  <td style="font-weight:bold; text-align:right;">${peluangHujan}%</td>
                              </tr>
                          </table>
                        </div>

                        <div style="padding:8px; background:#eee; font-size:12px; text-align:center; border-radius:0 0 5px 5px; border:1px solid #ddd; border-top:none;">
                          <b>Prediksi Besok:</b> ${hujanBesok} mm 
                          <br>
                          (${getRiskStatus(hujanBesok)})
                        </div>
                      </div>
                  `);
                })
                .catch(err => {
                    console.error("Gagal load API", err);
                    layer.setPopupContent(`<b>${namaKec}</b><br>Gagal memuat data.`);
                });
          }
        }).addTo(map);

      })
      .catch(err => alert("Error: " + err.message));


    // --- 4. LEGENDA PETA ---
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML += "<h4>Indeks Risiko</h4>";
        div.innerHTML += '<i style="background: #e74c3c"></i> > 50mm (Bahaya)<br>';
        div.innerHTML += '<i style="background: #f1c40f"></i> 20-50mm (Waspada)<br>';
        div.innerHTML += '<i style="background: #2ecc71"></i> < 20mm (Aman)<br>';
        div.innerHTML += '<i style="background: #bdc3c7"></i> Data Loading...<br>';
        return div;
    };
    legend.addTo(map);

        // Tambahkan kode ini sebelum closing script
    L.control.locate = L.Control.extend({
        onAdd: function(map) {
            var div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
            div.style.backgroundColor = 'white';
            div.style.width = '30px';
            div.style.height = '30px';
            div.style.cursor = 'pointer';
            div.innerHTML = '<div style="font-size:20px; text-align:center; line-height:30px;">üìç</div>';
            div.onclick = function() {
                map.locate({setView: true, maxZoom: 16});
            }
            return div;
        }
    });
    map.addControl(new L.control.locate({ position: 'topleft' }));

    map.on('locationfound', function(e) {
        L.circle(e.latlng, { radius: e.accuracy/2, color: 'blue' }).addTo(map)
        .bindPopup("Lokasi Anda").openPopup();
    });

  </script>
</body>
</html>