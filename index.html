<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Peringatan Dini Longsor Sukabumi</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  
  <style>
    /* Reset & Layout */
    body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    #map { height: 100vh; width: 100%; background: #ddd; }

    /* Judul Melayang */
    .map-title {
      position: absolute; 
      top: 20px; 
      left: 50%; 
      transform: translateX(-50%);
      z-index: 1000; 
      background: rgba(255, 255, 255, 0.95); 
      padding: 10px 25px; 
      border-radius: 30px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      text-align: center;
      border: 1px solid #999;
    }
    .map-title h2 { margin: 0; font-size: 18px; color: #2c3e50; }
    .map-title small { font-size: 12px; color: #7f8c8d; }

    /* Legenda di Pojok Kanan Bawah */
    .legend {
      background: white; 
      padding: 10px; 
      line-height: 20px; 
      color: #333;
      box-shadow: 0 0 15px rgba(0,0,0,0.2); 
      border-radius: 8px;
      font-size: 12px;
    }
    .legend h4 { margin: 0 0 5px; font-size: 13px; text-decoration: underline; }
    .legend i {
      width: 15px; height: 15px; 
      float: left; 
      margin-right: 8px; 
      opacity: 0.9; 
      border-radius: 3px;
    }
  </style>
</head>
<body>

  <div class="map-title">
    <h2>SI Peringatan Dini Longsor</h2>
    <small>Gunakan tombol Layer (Kanan Atas) untuk ganti mode</small>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // --- 1. SETUP PETA DASAR ---
    var map = L.map('map').setView([-7.05, 106.9], 10); 

    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles ¬© Esri'
    });
    
    var street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    });

    var labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
        attribution: '¬© CartoDB'
    });

    // Default layer: Satelit + Label
    street.addTo(map);

    // --- 2. LOGIKA WARNA & STATUS (LAMA & BARU) ---
    
    // [LAMA] Untuk Curah Hujan Live
    function getRiskColor(rain) {
        if (rain > 50) return '#e74c3c'; // MERAH (Bahaya)
        if (rain > 20) return '#f1c40f'; // KUNING (Waspada)
        return '#2ecc71';                // HIJAU (Aman)
    }

    function getRiskStatus(rain) {
        if (rain > 50) return 'BAHAYA (Potensi Longsor)';
        if (rain > 20) return 'WASPADA (Tanah Basah)';
        return 'AMAN (Normal)';
    }

    // [BARU] Untuk Model AI
    function getAiColor(riskClass) {
        if (riskClass === 2) return '#8e44ad'; // UNGU (Risiko Tinggi Model)
        if (riskClass === 1) return '#e67e22'; // ORANYE (Risiko Sedang)
        return '#3498db';                      // BIRU (Risiko Rendah)
    }

    // --- 3. MUAT DATA ---
    console.log("Memulai load data...");

    // Variabel Global untuk menyimpan referensi Layer
    let liveWeatherLayer;
    let geoAiLayer;
    let modelDataMap = {}; // Untuk menyimpan data JSON AI

    // Step 1: Load Data GeoAI dulu
    fetch('hasil_geoai.json')
      .then(res => res.json())
      .then(aiData => {
          // Petakan data AI ke object biar mudah dicari berdasarkan nama kecamatan
          aiData.forEach(item => {
              modelDataMap[item.nama.toLowerCase()] = item;
          });
          
          // Step 2: Load Peta Wilayah (GeoJSON)
          return fetch('BatasSukabumi.json');
      })
      .then(response => {
          if (!response.ok) throw new Error("Gagal load BatasSukabumi.json");
          return response.json();
      })
      .then(geojsonData => {
        
        console.log("JSON Wilayah dimuat.");

        // ==========================================================
        // LAYER A: LOGIKA LAMA (Live Weather dari Open-Meteo)
        // ==========================================================
        liveWeatherLayer = L.geoJSON(geojsonData, {
            renderer: L.canvas(),
            style: {
                color: 'white',
                weight: 1,
                fillOpacity: 0.6,
                fillColor: '#bdc3c7' 
            },
            onEachFeature: function(feature, layer) {
                // Logika Asli Kamu (Tidak Diubah)
                var namaKec = feature.properties.NAME_3 || "Kecamatan";
                var center = turf.centroid(feature).geometry.coordinates;

                layer.bindPopup(`<div style="text-align:center"><b>${namaKec}</b><br><small>Memuat data live...</small></div>`);

                var url = `https://api.open-meteo.com/v1/forecast?latitude=${center[1]}&longitude=${center[0]}&daily=precipitation_sum,windspeed_10m_max,precipitation_probability_max&timezone=Asia%2FBangkok`;

                fetch(url)
                .then(res => res.json())
                .then(weatherData => {
                    var hujanHariIni = weatherData.daily.precipitation_sum[0];
                    var anginHariIni = weatherData.daily.windspeed_10m_max[0];
                    var peluangHujan = weatherData.daily.precipitation_probability_max[0];
                    var hujanBesok = weatherData.daily.precipitation_sum[1];

                    layer.setStyle({
                        fillColor: getRiskColor(hujanHariIni),
                        fillOpacity: 0.7
                    });

                    // Konten Popup Asli
                    layer.setPopupContent(`
                        <div style="font-family:sans-serif; min-width:200px;">
                        <div style="background:${getRiskColor(hujanHariIni)}; color:white; padding:10px; border-radius:5px 5px 0 0; text-align:center;">
                            <h3 style="margin:0;">${namaKec}</h3>
                            <small>${getRiskStatus(hujanHariIni)}</small>
                        </div>
                        <div style="padding:10px; background:#f9f9f9; border:1px solid #ddd; border-top:none;">
                            <table style="width:100%; font-size:13px;">
                                <tr><td style="color:#555;">üåßÔ∏è Curah Hujan:</td><td style="font-weight:bold; text-align:right;">${hujanHariIni} mm</td></tr>
                                <tr><td style="color:#555;">üí® Angin Kencang:</td><td style="font-weight:bold; text-align:right;">${anginHariIni} km/h</td></tr>
                                <tr><td style="color:#555;">üìä Peluang Hujan:</td><td style="font-weight:bold; text-align:right;">${peluangHujan}%</td></tr>
                            </table>
                        </div>
                        <div style="padding:8px; background:#eee; font-size:12px; text-align:center; border-radius:0 0 5px 5px; border:1px solid #ddd; border-top:none;">
                            <b>Prediksi Besok:</b> ${hujanBesok} mm <br> (${getRiskStatus(hujanBesok)})
                        </div>
                        </div>
                    `);
                })
                .catch(err => {
                    console.error("Gagal load API", err);
                    layer.setPopupContent(`<b>${namaKec}</b><br>Gagal memuat data.`);
                });
            }
        });

        // ==========================================================
        // LAYER B: LOGIKA BARU (Integrasi Geo-AI)
        // ==========================================================
        geoAiLayer = L.geoJSON(geojsonData, {
            renderer: L.canvas(),
            style: function(feature) {
                var namaKec = (feature.properties.NAME_3 || "").toLowerCase();
                var data = modelDataMap[namaKec];
                
                // Jika ada di data AI, warnai sesuai risiko model. Jika tidak, abu-abu transparan.
                if(data) {
                    return { color: '#2c3e50', weight: 2, fillOpacity: 0.8, fillColor: getAiColor(data.risiko) };
                } else {
                    return { color: 'white', weight: 1, fillOpacity: 0.1, fillColor: '#999' };
                }
            },
            onEachFeature: function(feature, layer) {
                var rawNama = feature.properties.NAME_3 || "Kecamatan";
                var namaKec = rawNama.toLowerCase();
                var data = modelDataMap[namaKec];

                if(data) {
                    layer.bindPopup(`
                        <div style="font-family:sans-serif; min-width:180px;">
                            <div style="background:${getAiColor(data.risiko)}; color:white; padding:8px; border-radius:5px 5px 0 0; text-align:center;">
                                <b>${rawNama} (Geo-AI)</b>
                            </div>
                            <div style="padding:10px; background:#fff; border:1px solid #ddd;">
                                <b>Prediksi Model: Kelas ${data.risiko}</b><hr style="margin:5px 0">
                                üåßÔ∏è Hujan Input: ${data.hujan} mm<br>
                                ‚õ∞Ô∏è Kemiringan: ${data.lereng}¬∞<br>
                                üå± Tipe Lahan: ${data.lahan}
                            </div>
                        </div>
                    `);
                } else {
                    layer.bindPopup(`<b>${rawNama}</b><br>Tidak ada data prediksi AI.`);
                }
            }
        });


        // ==========================================================
        // SETTING LAYER CONTROL
        // ==========================================================
        
        // Default tampilkan layer Live
        liveWeatherLayer.addTo(map);

        var baseMaps = {
            "Satelit (Esri)": satellite,
            "Jalan Raya (OSM)": street,
            "Peta Putih (Carto)": labels
        };

        var overlayMaps = {
            "üåßÔ∏è Cuaca Real-time (API)": liveWeatherLayer,
            "ü§ñ Prediksi Model (Geo-AI)": geoAiLayer
        };

        L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

      })
      .catch(err => alert("Error load data: " + err.message));


    // --- 4. LEGENDA PETA (Digabung) ---
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML += "<h4>Legenda Peta</h4>";
        
        div.innerHTML += "<b>Cuaca Real-time:</b><br>";
        div.innerHTML += '<i style="background: #e74c3c"></i> > 50mm (Bahaya)<br>';
        div.innerHTML += '<i style="background: #f1c40f"></i> 20-50mm (Waspada)<br>';
        div.innerHTML += '<i style="background: #2ecc71"></i> < 20mm (Aman)<br>';
        
        div.innerHTML += "<hr style='margin:8px 0'><b>Model Geo-AI:</b><br>";
        div.innerHTML += '<i style="background: #8e44ad"></i> Tinggi (Kelas 2)<br>';
        div.innerHTML += '<i style="background: #e67e22"></i> Sedang (Kelas 1)<br>';
        div.innerHTML += '<i style="background: #3498db"></i> Rendah (Kelas 0)<br>';
        
        return div;
    };
    legend.addTo(map);

    // Fitur Lokasi (Tetap dipertahankan)
    L.control.locate = L.Control.extend({
        onAdd: function(map) {
            var div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
            div.style.backgroundColor = 'white';
            div.style.width = '30px';
            div.style.height = '30px';
            div.style.cursor = 'pointer';
            div.innerHTML = '<div style="font-size:20px; text-align:center; line-height:30px;">üìç</div>';
            div.onclick = function() {
                map.locate({setView: true, maxZoom: 16});
            }
            return div;
        }
    });
    map.addControl(new L.control.locate({ position: 'topleft' }));

    map.on('locationfound', function(e) {
        L.circle(e.latlng, { radius: e.accuracy/2, color: 'blue' }).addTo(map)
        .bindPopup("Lokasi Anda").openPopup();
    });

  </script>
</body>
</html>